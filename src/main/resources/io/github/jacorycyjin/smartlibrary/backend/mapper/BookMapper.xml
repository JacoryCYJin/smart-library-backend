<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.jacorycyjin.smartlibrary.backend.mapper.BookMapper">

    <!-- 图书基本信息结果映射 -->
    <resultMap id="BookResultMap" type="io.github.jacorycyjin.smartlibrary.backend.entity.Book">
        <id column="id" property="id"/>
        <result column="book_id" property="bookId"/>
        <result column="isbn" property="isbn"/>
        <result column="title" property="title"/>
        <result column="sub_title" property="subTitle"/>
        <result column="author_name" property="authorName"/>
        <result column="publisher" property="publisher"/>
        <result column="pub_date" property="pubDate"/>
        <result column="price" property="price"/>
        <result column="page_count" property="pageCount"/>
        <result column="cover_url" property="coverUrl"/>
        <result column="summary" property="summary"/>
        <result column="source_origin" property="sourceOrigin"/>
        <result column="source_url" property="sourceUrl"/>
        <result column="source_score" property="sourceScore"/>
        <result column="sentiment_score" property="sentimentScore"/>
        <result column="ctime" property="ctime"/>
        <result column="mtime" property="mtime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 搜索图书（只返回图书基本信息） -->
    <select id="searchBook" resultMap="BookResultMap">
        SELECT DISTINCT b.*
        FROM book b
        <if test="categoryId != null">
            LEFT JOIN book_category_rel bcr ON b.id = bcr.book_id AND bcr.deleted = 0
        </if>
        <if test="tagId != null">
            LEFT JOIN book_tag_rel btr ON b.id = btr.book_id AND btr.deleted = 0
        </if>
        <where>
            b.deleted = 0
            <!-- 关键词搜索：匹配书名、作者、出版社、ISBN -->
            <if test="keyword != null and keyword != ''">
                AND (
                    b.title LIKE CONCAT('%', #{keyword}, '%')
                    OR b.author_name LIKE CONCAT('%', #{keyword}, '%')
                    OR b.publisher LIKE CONCAT('%', #{keyword}, '%')
                    OR b.isbn LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <!-- 筛选条件：分类ID -->
            <if test="categoryId != null">
                AND bcr.category_id = #{categoryId}
            </if>
            <!-- 筛选条件：标签ID -->
            <if test="tagId != null">
                AND btr.tag_id = #{tagId}
            </if>
            <!-- 筛选条件：价格区间 -->
            <if test="minPrice != null">
                AND b.price &gt;= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND b.price &lt;= #{maxPrice}
            </if>
            <!-- 筛选条件：出版日期区间 -->
            <if test="pubDateStart != null">
                AND b.pub_date &gt;= #{pubDateStart}
            </if>
            <if test="pubDateEnd != null">
                AND b.pub_date &lt;= #{pubDateEnd}
            </if>
            <!-- 筛选条件：最低原站评分 -->
            <if test="minSourceScore != null">
                AND b.source_score &gt;= #{minSourceScore}
            </if>
            <!-- 筛选条件：最低情感分 -->
            <if test="minSentimentScore != null">
                AND b.sentiment_score &gt;= #{minSentimentScore}
            </if>
        </where>
        ORDER BY b.ctime DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据图书业务ID查询单本图书 -->
    <select id="selectByBookId" resultMap="BookResultMap">
        SELECT *
        FROM book
        WHERE book_id = #{bookId}
          AND deleted = 0
    </select>
</mapper>